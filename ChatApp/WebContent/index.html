<!DOCTYPE html>
<html>
<head>
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="resources/js/jquery-1.11.0.js"></script>
<link rel="stylesheet" type="text/css" href="resources/css/mystyle.css">
<title>Insert title here</title>
</head>
<body class="body">
<div id="srednji">
	<h1>Welcome to chatapp</h1>
	<p></p>
	<a href="#" id="logoutlink">LogOut</a>
		
	<div id="registerDiv">
	<h3>Register</h3>
		<form action="" method="POST">
			<p>USERNAME:</p><input type="text" id="rusername">
			<p>PASSWORD:</p><input type="password" id="rpassword">
			<p>REPEAT PASSWORD:</p><input type="password" id="rpasswordRepeat"> <br>
			<br>
			<input type="button"  id="registersubmit" value="Register" onclick="return register()">
		</form>
		<p>You can login <a href="#" id="loginlinkfromregister">here</a></p>
	</div>
	
	<div id="logovanje">
		<h1 id="loginerror">Error!</h1>
		<h3>Please Log In:</h3>
		<form action="" method="POST">
			<p>USERNAME:</p><input type="text" id="lusername">
			<p>PASSWORD:</p><input type="password" id="lpassword"> <br>
			<br>
			<input type="button" id="loginsubmit" onclick="return login()" value="Login">
		</form>
		<p>Or you can register <a href="#" id="registerLink">here</a></p>
	</div>
	
</div>
	
	
	
	
	<div id="kasnije">
	<h1>JavaScript web socket demo</h1>
	<div id="container">
		<label>Enter text:</label><input type="text" id="text" /> <input
			type="button" id="send" value="send" />

		<p></p>

		<div id="chatLog"></div>

	</div>
	</div>
	<script>
	var usernamee;

	function register(){
		var username = $("#rusername").val();
		var password = $("#rpassword").val();
		var rpassword = $("#rpasswordRepeat").val();

		if(password !== rpassword){
			alert("Repeated password must be same as password!");
			return false;
		}


		if(password == '' || rpassword == '' || password == ''){
			alert("All fields must be filled!");
			return false;
		}
		
		$.ajax({ 
	        type: 'POST',
	        url: 'rest/userChatController/registerUser/'+username+'/'+password + '/' + rpassword,
	        dataType: 'json',
	        success: function(data){
	        	console.log(data.responseText);
	        	ready();
	        },
	        complete: function(data){
	            console.log(data.responseText);
	            ready();
	        }
		});
		}

	
function login(){
	var username = $("#lusername").val();
	var password = $("#lpassword").val();

	if(password == '' || password == ''){
		alert("All fields must be filled!");
		return false;
	}

	
	$.ajax({ 
        type: 'POST',
        url: 'rest/userChatController/loginUser/'+username+'/'+password,
        dataType: 'json',
        success: function(data){
        	console.log(data.responseText);
            var ret = data.responseText;
            if(ret.includes("Done")){
                usernamee = username;

           	 $("#logoutlink").show();
           	 	$("#loginerror").hide();
            	$("#logovanje").hide();
            	$("#kasnije").show();
            	whenLogged();
             }else{
            	 $("#loginerror").show();
             }
        },
        complete: function(data){
            console.log(data.responseText);
            var ret = data.responseText;
            if(ret.includes("Done")){
            	usernamee = username;
              	 $("#logoutlink").show();
           	 	$("#loginerror").hide();
            	$("#logovanje").hide();
            	$("#kasnije").show();
            	whenLogged();
             }else{
            	 $("#loginerror").show();
             }
        }
        
	});
	return false;
}
	
$(document).ready(function() {
	 ready();
	});
	
function ready(){
	init();
	$("#logoutlink").hide();
	$("#loginerror").hide();
	$("#registerDiv").hide();
	$("#kasnije").hide();
	$("#loginerror").hide();	
 	$("#logovanje").show();
 	$("#lusername").val('');
	$("#lpassword").val('');
}

function init(){
	$.ajax({ 
        type: 'GET',
        url: 'rest/userChatController/init',
        dataType: 'json',
        success: function(data){
        	console.log(data);
        }
        
	});
};


$('#lpassword').keypress(function(event) {
	if (event.keyCode == '13') {
  		login();
	}
});	

$('#rpasswordRepeat').keypress(function(event) {
	if (event.keyCode == '13') {
		register();
	}
});

$('#registerLink').click(function(){
	$("#logoutlink").hide();
	$("#loginerror").hide();
	$("#logovanje").hide();
	$("#registerDiv").show();
	$("#kasnije").hide();
});

$('#loginlinkfromregister').click(function(){
	ready();
});


$('#logoutlink').click(function(){
	$.ajax({ 
        type: 'GET',
        url: 'rest/userChatController/logoutUser/'+ usernamee,
        dataType: 'json',
        success: function(data){
        	console.log(dataresponseText);
        },
        complete: function(data){
        	ready();
        }
        
	});
});

function whenLogged(){
	var socket;
	function send(){
    	var text = $('#text').val();

    	if(text==""){
        	message('<p>Please enter a message');
        	return ;
    	}
    	try{
        	socket.send(text);
        	message('<p>Sent: '+text);
    	} catch(exception){
       		message('<p>Error: ' + exception);
    	}
	}

	function message(msg){
		console.log(msg);
  		$('#chatLog').append(msg+'</p>');
	}

	$('#text').keypress(function(event) {
    	if (event.keyCode == '13') {
      		send();
    	}
	});	


	$('#send').click(function(){
		send();
	});


	

	if(!("WebSocket" in window)){
		$('#chatLog, input, button, #examples').fadeOut("fast");
		$('<p>Oh no, you need a browser that supports WebSockets. How about <a href="http://www.google.com/chrome">Google/a>?</p>').appendTo('#container');
	} else {
    	var host = "ws://localhost:8080/ChatApp/websocket";
    	try{
        	socket = new WebSocket(host);
        	message('<p>connect: Socket Status: '+socket.readyState);

        	socket.onopen = function(){
       	 		message('<p>onopen: Socket Status: '+socket.readyState+' (open)');
        	}

       	 	socket.onmessage = function(msg){
       	 		message('<p>onmessage: Received: '+msg.data);
        	}

        	socket.onclose = function(){
        		message('<p>onclose: Socket Status: '+socket.readyState+' (Closed)');
        		socket = null;
        	}			

    	} catch(exception){
       		message('<p>Error'+exception);
    	}

	}//End else
};

</script>
</body>
</html>